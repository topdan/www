<!DOCTYPE html>
<html>
<head>
  <title>Infinite Scrolling with AJAX and Rails - topdan.com</title>
  <meta charset="UTF-8">
  <meta name="description" content="Ruby on Rails and jQuery team up to allow your visitors to scroll through all your content without initially loading them all.">
  <meta name="author" content="Dan Cunning">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@itopdan">
  <meta name="twitter:title" content="Infinite Scrolling with AJAX and Rails">
  <meta name="twitter:description" content="Ruby on Rails and jQuery team up to allow your visitors to scroll through all your content without initially loading them all.">
  <meta name="twitter:url" content="http://www.topdan.com/ruby-on-rails/simple-infinite-scrolling.html">
  <meta name="og:locale" content="en_US">
  <meta name="og:type" content="article">
  <meta name="og:url" content="http://www.topdan.com/ruby-on-rails/simple-infinite-scrolling.html">
  <meta name="og:title" content="Infinite Scrolling with AJAX and Rails">
  <meta name="og:description" content="Ruby on Rails and jQuery team up to allow your visitors to scroll through all your content without initially loading them all.">
  <link rel="shortcut icon" href="../assets/favicon-e45cdd6cc07e8858a985e6014e38a603.png">
  <link rel="stylesheet" media="all" href="../assets/site-873ddaadf34e2be81cc81a994a417b93.css"><!--[if lt IE 9]><script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->

  <script type="text/javascript">
  if (!document.cookie || document.cookie.indexOf('tracking_off') == -1) {
    var _gaq = _gaq || [];

    _gaq.push(['_setAccount', 'UA-12957077-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  }
  </script>
</head>
<body id="simple-infinite-scrolling">
  <div class="container bg-black full-width">
    <div class="row navigation">
      <a id="top"></a> <a href="finding-your-most-active-users-with-google-analytics.html" class="previous"><span class="fa fa-arrow-left">&nbsp;</span> <span class="desktop">Finding Your Most Active Users</span><span class="mobile">Previous</span></a> <a href="beware-active-record-callbacks.html" class="next"><span class="desktop">Beware ActiveRecord callbacks</span><span class="mobile">Next</span> <span class="fa fa-arrow-right">&nbsp;</span></a>
      <p><a href="../"><span class="fa fa-home">&nbsp;</span></a> &nbsp;»&nbsp;<span class="title desktop"><a href="index.html">Ruby on Rails</a></span><span class="mobile"><a href="index.html"><span class="fa fa-folder-open">&nbsp;</span></a></span></p>
    </div>
    <div class="row bg-white">
      <div class="col-md-12">
        <div class="width-640 ml-auto mr-auto">
          <p class="mt-05e mb-15e ta-right c-ccc">Published by Dan on Jun 16, 2014</p>
          <h1 class="center of-yh mb-0"><a href="simple-infinite-scrolling.html">Infinite Scrolling with AJAX and Rails</a></h1>
        </div>
      </div>
    </div>
    <div class="row bg-white">
      <div class="col-md-12">
        <div class="width-640 ml-auto mr-auto post">
          <!-- post:content:start -->
          <ul>
            <li>
              <a href="#introduction">Introduction</a>
            </li>
            <li>
              <a href="#how-it-works">How it Works</a>
              <ul>
                <li>
                  <a href="#gemfile">Gemfile</a>
                </li>
                <li>
                  <a href="#controller">Controller</a>
                </li>
                <li>
                  <a href="#html-templates">HTML Templates</a>
                </li>
                <li>
                  <a href="#javascript">Client-Side Javascript</a>
                </li>
                <li>
                  <a href="#post-js">Javascript Template</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#wrapup">Wrap-up</a>
            </li>
          </ul>
          <h2 id="introduction"><a href="#introduction">Introduction</a></h2>
          <p>Infinite scrolling appends more content to the end of the page before the viewer gets to it, so they can just keep scrolling unabated and the application doesn't need to initially load a bunch of records only a small percent of viewers will ever scroll down to.</p>
          <h2 id="how-it-works"><a href="#how-it-works">How it Works</a></h2>
          <p class="alert alert-info"><strong>Summary:</strong> Rails renders the HTML like always, but there's a javascript file that watches the scrollbar and fires off an ajax request that returns some javascript that appends new content.</p>
          <h3 id="gemfile"><a href="#gemfile">Gemfile</a></h3>
          <p>ActiveRecord has <a href="https://www.ruby-toolbox.com/categories/pagination">a lot of pagination gems</a> that groups your records into pages.</p>
          <div class="highlight">
            <pre><span class="c1"># Gemfile</span>

<span class="n">gem</span> <span class="s1">'kaminari'</span>
<span class="c1"># gem 'will_paginate'</span>
</pre>
          </div>
          <h4 id="controller"><a href="#controller">Controller</a></h4>
          <p>Your controller queries the page param or the first page if not provided.</p>
          <div class="highlight">
            <pre><span class="c1"># controllers/posts_controller.rb</span>
<span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">)</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">per</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
          </div>
          <h4 id="html-templates"><a href="#html-templates">HTML Templates</a></h4>
          <p>HTML requests will render like they normally do, along with a "View More" link to load the next page. You can use the <code>paginate</code> view helper method provided by your gem, but I want to be explicit about the CSS classes here.</p>
          <div class="highlight">
            <pre><span class="c">&lt;!-- views/posts/index.html.erb --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span><span class="p">(</span><span class="ss">partial</span><span class="p">:</span> <span class="s1">'post'</span><span class="p">,</span> <span class="ss">collection</span><span class="p">:</span> <span class="vi">@posts</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">current_page</span> <span class="o">==</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">total_pages</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">"view-more"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s1">'View More'</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">current_page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre>
          </div>
          <div class="highlight">
            <pre><span class="c">&lt;!-- views/posts/_post.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">div_for</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">excerpt</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre>
          </div>
          <h4 id="javascript"><a href="#javascript">Client-Side Javascript</a></h4>
          <p>Client-side javascript watches for when the scrollbar gets towards the bottom and ajax-requests javascript using the "View More" link's URL along with a failsafe for requesting pages too quickly and allowing the viewer to paginate manually.</p>
          <div class="highlight">
            <pre><span class="c1"># assets/javascripts/infinite-scroll.js.coffee</span>
<span class="nx">$</span> <span class="nf">-&gt;</span>
  <span class="nv">content = </span><span class="nx">$</span><span class="p">(</span><span class="s">'#content'</span><span class="p">)</span>    <span class="c1"># where to load new content</span>
  <span class="nv">viewMore = </span><span class="nx">$</span><span class="p">(</span><span class="s">'#view-more'</span><span class="p">)</span> <span class="c1"># tag containing the "View More" link</span>

  <span class="nv">isLoadingNextPage = </span><span class="kc">false</span>  <span class="c1"># keep from loading two pages at once</span>
  <span class="nv">lastLoadAt = </span><span class="kc">null</span>          <span class="c1"># when you loaded the last page</span>
  <span class="nv">minTimeBetweenPages = </span><span class="mi">5000</span> <span class="c1"># milliseconds to wait between loading pages</span>
  <span class="nv">loadNextPageAt = </span><span class="mi">1000</span>      <span class="c1"># pixels above the bottom</span>

  <span class="nv">waitedLongEnoughBetweenPages = </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">lastLoadAt</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">lastLoadAt</span> <span class="o">&gt;</span> <span class="nx">minTimeBetweenPages</span>

  <span class="nv">approachingBottomOfPage = </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">+</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">-</span> <span class="nx">loadNextPageAt</span>

  <span class="nv">nextPage = </span><span class="nf">-&gt;</span>
    <span class="nv">url = </span><span class="nx">viewMore</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">'a'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">'href'</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">if</span> <span class="nx">isLoadingNextPage</span> <span class="o">||</span> <span class="o">!</span><span class="nx">url</span>

    <span class="nx">viewMore</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">'loading'</span><span class="p">)</span>
    <span class="nv">isLoadingNextPage = </span><span class="kc">true</span>
    <span class="nv">lastLoadAt = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nv">url: </span><span class="nx">url</span><span class="p">,</span>
      <span class="nv">method: </span><span class="s">'GET'</span><span class="p">,</span>
      <span class="nv">dataType: </span><span class="s">'script'</span><span class="p">,</span>
      <span class="nv">success: </span><span class="nf">-&gt;</span>
        <span class="nx">viewMore</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">'loading'</span><span class="p">);</span>
        <span class="nv">isLoadingNextPage = </span><span class="kc">false</span><span class="p">;</span>
        <span class="nv">lastLoadAt = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="p">})</span>

  <span class="c1"># watch the scrollbar</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">scroll</span> <span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">approachingBottomOfPage</span><span class="p">()</span> <span class="o">&amp;&</span> <span class="nx">waitedLongEnoughBetweenPages</span><span class="p">()</span>
      <span class="nx">nextPage</span><span class="p">()</span>

  <span class="c1"># failsafe in case the user gets to the bottom</span>
  <span class="c1"># without infinite scrolling taking affect.</span>
  <span class="nx">viewMore</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">'a'</span><span class="p">).</span><span class="nx">click</span> <span class="nf">(e) -&gt;</span>
    <span class="nx">nextPage</span><span class="p">()</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefaults</span><span class="p">()</span>
</pre>
          </div>
          <h4 id="post-js"><a href="#post-js">Javascript Template</a></h4>
          <p>The Rails controller remains unchanged, but since the ajax call is requesting javascript it renders <code>index.js.erb</code> instead of <code>index.html.erb</code>. This template appends the new posts to the page and updates the "View More" link URL. When the viewer reaches the last page, it removes the "View More" link and the client-side javascript stops requesting more pages.</p>
          <div class="highlight">
            <pre><span class="c1">// views/posts/index.js.erb</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">"&lt;%=j render(partial: 'post', collection: @posts, format: 'html') %&gt;"</span><span class="p">);</span>

<span class="o">&lt;%</span> <span class="k">if</span> <span class="err">@</span><span class="nx">posts</span><span class="p">.</span><span class="nx">current_page</span> <span class="o">==</span> <span class="err">@</span><span class="nx">posts</span><span class="p">.</span><span class="nx">total_pages</span> <span class="o">%&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#view-more'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
<span class="o">&lt;%</span> <span class="k">else</span> <span class="o">%&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#view-more a'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">,</span> <span class="s1">'&lt;%= url_for(page: @posts.current_page + 1) %&gt;'</span><span class="p">);</span>
<span class="o">&lt;%</span> <span class="nx">end</span> <span class="o">%&gt;</span>
</pre>
          </div>
          <h2 id="wrapup"><a href="#wrapup">Wrap-up</a></h2>
          <p>Simple right? Rails returning javascript simplifies the client-side code significantly. Your HTML may not be exactly like mine, but the jQuery and Rails code should be straight-forward enough for you to tailor it to your web design.</p><!-- post:content:end -->
        </div>
      </div>
    </div>
    <div class="row navigation bb-ccc">
      <a href="finding-your-most-active-users-with-google-analytics.html" class="previous"><span class="fa fa-arrow-left">&nbsp;</span> <span class="desktop">Finding Your Most Active Users</span><span class="mobile">Previous</span></a> <a href="beware-active-record-callbacks.html" class="next"><span class="desktop">Beware ActiveRecord callbacks</span><span class="mobile">Next</span> <span class="fa fa-arrow-right">&nbsp;</span></a>
      <p><a href="../"><span class="fa fa-home">&nbsp;</span></a> &nbsp;»&nbsp;<span class="title desktop"><a href="index.html">Ruby on Rails</a></span><span class="mobile"><a href="index.html"><span class="fa fa-folder-open">&nbsp;</span></a></span></p>
    </div>
    <div class="row introduction pb-2e bb-ccc mb-1e">
      <div class="col-md-6 mt-2e center">
        <h1 class="mt-0"><a title="Dan Cunning" class="fs-45 fw-normal shadow-silver" href="../">Dan Cunning</a></h1>
        <p class="reference mt-05e"><a title="github" class="white" href="https://github.com/topdan"><span class="fa fa-github">&nbsp;</span> GitHub</a> <a title="Twitter" class="white" href="https://www.linkedin.com/in/dancunning"><span class="fa fa-linkedin-square">&nbsp;</span> LinkedIn</a> <a title="Email" class="white" href="mailto:dan@topdan.com"><span class="fa fa-envelope">&nbsp;</span> Email</a></p>
      </div>
      <div class="col-sm-offset-1 col-md-4 mt-2e">
        <img width="75" height="75" class="img-circle fl-left mr-10" src="../assets/dan-79508ca0775ace507f1dc34d151bba0f.jpg" alt="Dan">
        <p class="underline-links">I'm a <a href="./">Ruby on Rails</a> contractor from Atlanta GA, focusing on simplicity and usability through solid design. <a href="../dan-cunning.html">Read more »</a></p>
      </div>
    </div>
    <div class="row fs-12 mt-1e center">
      <div class="col-md-6">
        <p class="underline-links mb-1e">View Source: <a href="https://github.com/topdan/www/blob/master/ruby-on-rails/simple-infinite-scrolling.html">HTML</a> | <a href="https://github.com/topdan/www/blob/master/ruby-on-rails/simple-infinite-scrolling.json">JSON</a> | <a href="https://github.com/topdan/www/blob/master/ruby-on-rails/simple-infinite-scrolling.html.md">View</a></p>
      </div>
      <div class="col-md-6">
        <p class="mb-1e">© 2012-2016 Dan Cunning. All rights reserved.</p>
      </div>
    </div>
  </div>
</body>
</html>
