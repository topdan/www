<!DOCTYPE html>

<html>
<head>
  <title>Simple Infinite Scrolling with AJAX and Rails - topdan.com</title>
  <meta charset="UTF-8">
  <meta content="Ruby on Rails and jQuery team up to allow your visitors to scroll through all your content without initially loading them all." name="description">
  <meta name="author" content="Dan Cunning">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@itopdan">
  <meta name="twitter:url" content="http://www.topdan.com/ruby-on-rails/simple-infinite-scrolling.html">
  <meta content="Simple Infinite Scrolling with AJAX and Rails" name="twitter:title">
  <meta content="Ruby on Rails and jQuery team up to allow your visitors to scroll through all your content without initially loading them all." name="twitter:description">
  <link rel="shortcut icon" href="/assets/favicon-0908da29aa499222bb570a239cf87dbf.png">
  <link href="/assets/site-e972e3e1edfc6cf95160eded172dc793.css" media="all" rel="stylesheet"><!--[if lt IE 9]><script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->

  <script type="text/javascript">
var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12957077-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script>
</head>

<body id="simple-infinite-scrolling" class="navigatable">
  <a id="top"></a>

  <ul class="navigation">
    <li class="prev">
      <a href="/ruby-on-rails/finding-your-most-active-users-with-google-analytics.html"><i class="icon-white icon-arrow-left">&nbsp;</i> <span class="more">Finding Your Most Active Users with Google Analytics</span><span class="less">Previous</span></a>
    </li>

    <li>
      <a href="/" class="icon"><i class="icon-white icon-home">&nbsp;</i></a>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/technology/">Technology</a></span><span class="less"><a href="/technology/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/ruby-on-rails/">Ruby on Rails</a></span><span class="less"><a href="/ruby-on-rails/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>
    </li>

    <li class="next">
      <a href="/technology/past-present-and-future-of-computers.html"><span class="more">The Past, Present, and Future of Computers</span><span class="less">Next</span> <i class="icon-white icon-arrow-right">&nbsp;</i></a>
    </li>
  </ul>

  <div class="content">
    <div class="container post">
      <p class="byline">Dan wrote this on Jun 16</p>

      <h1><a href="/ruby-on-rails/simple-infinite-scrolling.html">Simple Infinite Scrolling with AJAX and Rails</a></h1><!-- post:content:start -->

      <ul>
        <li>
          <a href="#introduction">Introduction</a>
        </li>

        <li>
          <a href="#how-it-works">How it Works</a>

          <ul>
            <li>
              <a href="#gemfile">Gemfile</a>
            </li>

            <li>
              <a href="#controller">Controller</a>
            </li>

            <li>
              <a href="#html-templates">HTML Templates</a>
            </li>

            <li>
              <a href="#javascript">Client-Side Javascript</a>
            </li>

            <li>
              <a href="#post-js">Javascript Template</a>
            </li>
          </ul>
        </li>

        <li>
          <a href="#wrapup">Wrap-up</a>
        </li>
      </ul>

      <h2 id="introduction"><a href="#introduction">Introduction</a></h2>

      <p>Infinite scrolling appends more content to the end of the page before the viewer gets to it, so they can just keep scrolling unabated and the application doesn't need to initially load a bunch of records only a small percent of viewers will ever scroll down to.</p>

      <h2 id="how-it-works"><a href="#how-it-works">How it Works</a></h2>

      <p class="alert alert-info"><strong>Summary:</strong> Rails renders the HTML like always, but there's a javascript file that watches the scrollbar and fires off an ajax request that returns some javascript that appends new content.</p>

      <h3 id="gemfile"><a href="#gemfile">Gemfile</a></h3>

      <p>ActiveRecord has <a href="https://www.ruby-toolbox.com/categories/pagination">a lot of pagination gems</a> that groups your records into pages.</p>

      <div class="highlight">
        <pre>
<span class="c1"># Gemfile</span>

<span class="n">gem</span> <span class="s1">'kaminari'</span>
<span class="c1"># gem 'will_paginate'</span>
</pre>
      </div>

      <h4 id="controller"><a href="#controller">Controller</a></h4>

      <p>Your controller queries the page param or the first page if not provided.</p>

      <div class="highlight">
        <pre>
<span class="c1"># controllers/posts_controller.rb</span>
<span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">)</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">per</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
      </div>

      <h4 id="html-templates"><a href="#html-templates">HTML Templates</a></h4>

      <p>HTML requests will render like they normally do, along with a "View More" link to load the next page. You can use the <code>paginate</code> view helper method provided by your gem, but I want to be explicit about the CSS classes here.</p>

      <div class="highlight">
        <pre>
<span class="c">&lt;!-- views/posts/index.html.erb --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span><span class="p">(</span><span class="ss">partial</span><span class="p">:</span> <span class="s1">'post'</span><span class="p">,</span> <span class="ss">collection</span><span class="p">:</span> <span class="vi">@posts</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">current_page</span> <span class="o">==</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">total_pages</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">"view-more"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s1">'View More'</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">current_page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre>
      </div>

      <div class="highlight">
        <pre>
<span class="c">&lt;!-- views/posts/_post.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">div_for</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">excerpt</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre>
      </div>

      <h4 id="javascript"><a href="#javascript">Client-Side Javascript</a></h4>

      <p>Client-side javascript watches for when the scrollbar gets towards the bottom and ajax-requests javascript using the "View More" link's URL along with a failsafe for requesting pages too quickly and allowing the viewer to paginate manually.</p>

      <div class="highlight">
        <pre>
<span class="c1">// assets/javascripts/infinite-scroll.js</span>
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">);</span>    <span class="c1">// where to load new content</span>
  <span class="kd">var</span> <span class="nx">viewMore</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#view-more'</span><span class="p">);</span> <span class="c1">// tag containing the "View More" link</span>

  <span class="kd">var</span> <span class="nx">isLoadingNextPage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>  <span class="c1">// keep from loading two pages at once</span>
  <span class="kd">var</span> <span class="nx">lastLoadAt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>          <span class="c1">// when you loaded the last page</span>
  <span class="kd">var</span> <span class="nx">minTimeBetweenPages</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="c1">// milliseconds to wait between loading pages</span>
  <span class="kd">var</span> <span class="nx">loadNextPageAt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>      <span class="c1">// pixels above the bottom</span>

  <span class="kd">var</span> <span class="nx">waitedLongEnoughBetweenPages</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">lastLoadAt</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">lastLoadAt</span> <span class="o">&gt;</span> <span class="nx">minTimeBetweenPages</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">approachingBottomOfPage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">+</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">-</span> <span class="nx">loadNextPageAt</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">nextPage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">viewMore</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isLoadingNextPage</span> <span class="o">||</span> <span class="o">!</span><span class="nx">url</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="nx">viewMore</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'loading'</span><span class="p">);</span>
    <span class="nx">isLoadingNextPage</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">lastLoadAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'script'</span><span class="p">,</span>
      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">viewMore</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'loading'</span><span class="p">);</span>
        <span class="nx">isLoadingNextPage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">lastLoadAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">};</span>

  <span class="c1">// watch the scrollbar</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">scroll</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">approachingBottomOfPage</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">waitedLongEnoughBetweenPages</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">nextPage</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// failsafe in case the user gets to the bottom</span>
  <span class="c1">// without infinite scrolling taking affect.</span>
  <span class="nx">viewMore</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'a'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">nextPage</span><span class="p">();</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefaults</span><span class="p">();</span>
  <span class="p">})</span>

<span class="p">});</span>
</pre>
      </div>

      <h4 id="post-js"><a href="#post-js">Javascript Template</a></h4>

      <p>The Rails controller remains unchanged, but since the ajax call is requesting javascript it renders <code>index.js.erb</code> instead of <code>index.html.erb</code>. This template appends the new posts to the page and updates the "View More" link URL. When the viewer reaches the last page, it removes the "View More" link and the client-side javascript stops requesting more pages.</p>

      <div class="highlight">
        <pre>
<span class="c1">// views/posts/index.js.erb</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">"&lt;%=j render(partial: 'post', collection: @posts, format: 'html') %&gt;"</span><span class="p">);</span>

<span class="o">&lt;%</span> <span class="k">if</span> <span class="err">@</span><span class="nx">posts</span><span class="p">.</span><span class="nx">current_page</span> <span class="o">==</span> <span class="err">@</span><span class="nx">posts</span><span class="p">.</span><span class="nx">total_pages</span> <span class="o">%&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#view-more'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
<span class="o">&lt;%</span> <span class="k">else</span> <span class="o">%&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#view-more a'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">,</span> <span class="s1">'&lt;%= url_for(page: @posts.current_page + 1) %&gt;'</span><span class="p">);</span>
<span class="o">&lt;%</span> <span class="nx">end</span> <span class="o">%&gt;</span>
</pre>
      </div>

      <h2 id="wrapup"><a href="#wrapup">Wrap-up</a></h2>

      <p>Simple right? Rails returning javascript simplifies the client-side code significantly. Your HTML may not be exactly like mine, but the jQuery and Rails code should be straight-forward enough for you to tailor it to your web design.</p><!-- post:content:end -->
    </div>
  </div>

  <div id="footer">
    <ul class="navigation">
      <li class="prev">
        <a href="/ruby-on-rails/finding-your-most-active-users-with-google-analytics.html"><i class="icon-white icon-arrow-left">&nbsp;</i> <span class="more">Finding Your Most Active Users with Google Analytics</span><span class="less">Previous</span></a>
      </li>

      <li>
        <a href="/" class="icon"><i class="icon-white icon-home">&nbsp;</i></a>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/technology/">Technology</a></span><span class="less"><a href="/technology/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/ruby-on-rails/">Ruby on Rails</a></span><span class="less"><a href="/ruby-on-rails/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>
      </li>

      <li class="next">
        <a href="/technology/past-present-and-future-of-computers.html"><span class="more">The Past, Present, and Future of Computers</span><span class="less">Next</span> <i class="icon-white icon-arrow-right">&nbsp;</i></a>
      </li>
    </ul>

    <div class="introduction row-fluid">
      <div class="title span6">
        <h1><a href="/" title="Dan Cunning">Dan Cunning</a></h1>

        <ul>
          <li>
            <a href="http://twitter.com/itopdan" title="Twitter"><span class="about-twitter">&nbsp;</span> twitter</a>
          </li>

          <li>
            <a href="https://github.com/topdan" title="github"><span class="about-github">&nbsp;</span> github</a>
          </li>

          <li>
            <a href="mailto:dan@topdan.com" title="Email"><span class="about-email">&nbsp;</span> email</a>
          </li>
        </ul>
      </div>

      <div class="profile span6">
        <img alt="Dan" height="75" src="/assets/dan-42c943bc366d944393575004c9b58cfc.jpg" width="75">

        <p>I'm a <a href="/ruby-on-rails/">Ruby on Rails</a> contractor from Atlanta GA, focusing on simplicity and usability through solid design. <a href="/dan-cunning.html">Read more &raquo;</a></p>
      </div>
    </div>

    <div id="copyright">
      <p id="view-source"><a href="https://www.github.com/topdan/www/blob/master/ruby-on-rails/simple-infinite-scrolling.html">View Source</a></p>

      <p>&copy; 2012-2014 Dan Cunning. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
