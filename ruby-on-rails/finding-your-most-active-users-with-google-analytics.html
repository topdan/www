<!DOCTYPE html>

<html>
<head>
  <title>Finding Your Most Active Users with Google Analytics - topdan.com</title>
  <meta charset="UTF-8">
  <meta content="Google Analytics is normally used to track a website's visitors and pageviews, but it can also track specific users, which can be invaluable information as you develop your customer base. Who is the most active? What are they using? Whose usage is fading?" name="description">
  <meta name="author" content="Dan Cunning">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@itopdan">
  <meta name="twitter:url" content="http://www.topdan.com/ruby-on-rails/finding-your-most-active-users-with-google-analytics.html">
  <meta content="Finding Your Most Active Users with Google Analytics" name="twitter:title">
  <meta content="Google Analytics is normally used to track a website's visitors and pageviews, but it can also track specific users, which can be invaluable information as you develop your customer base. Who is the most active? What are they using? Whose usage is fading?" name="twitter:description">
  <link rel="shortcut icon" href="/assets/favicon-66cadfcf1b17a3b1fa156a0ca99f973c.png">
  <link href="/assets/site-67bdcd85a4602a312bb4535e19e2cebe.css" media="all" rel="stylesheet"><!--[if lt IE 9]><script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script><![endif]-->

  <script type="text/javascript">
var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12957077-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script>
</head>

<body id="finding-your-most-active-users-with-google-analytics" class="navigatable">
  <a id="top"></a>

  <ul class="navigation">
    <li class="prev">
      <a href="/ruby-on-rails/ajax-toggle-buttons.html"><i class="icon-white icon-arrow-left">&nbsp;</i> <span class="more">Easy Ajax Toggle Buttons</span><span class="less">Previous</span></a>
    </li>

    <li>
      <a href="/" class="icon"><i class="icon-white icon-home">&nbsp;</i></a>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/technology/">Technology</a></span><span class="less"><a href="/technology/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/ruby-on-rails/">Ruby on Rails</a></span><span class="less"><a href="/ruby-on-rails/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>
    </li>

    <li class="next">
      <a href="/ruby-on-rails/simple-infinite-scrolling.html"><span class="more">Simple Infinite Scrolling with AJAX and Rails</span><span class="less">Next</span> <i class="icon-white icon-arrow-right">&nbsp;</i></a>
    </li>
  </ul>

  <div class="content">
    <div class="container post">
      <p class="byline">Dan wrote this on May 29</p>

      <h1><a href="/ruby-on-rails/finding-your-most-active-users-with-google-analytics.html">Finding Your Most Active Users with Google Analytics</a></h1><!-- post:content:start -->

      <ul>
        <li>
          <a href="#the-introduction">Introduction</a>
        </li>

        <li>
          <a href="#tracking-user-ids">Tracking User IDs</a>
        </li>

        <li>
          <a href="#querying-the-google-api">Querying Google Analytics</a>
        </li>

        <li>
          <a href="#generating-an-email">Generating an Email</a>
        </li>

        <li>
          <a href="#scheduling-the-email">Scheduling the Email</a>
        </li>

        <li>
          <a href="#conclusion">Conclusion</a>
        </li>
      </ul>

      <h2 id="the-introduction"><a href="#the-introduction">Introduction</a></h2>

      <p>You're using Google Analytics to track your web app's visitors, but you don't have visitors: you have users. Don't you want to know what they are doing? Who are your most active users? What do they use the most? Who should you contact directly about a feature improvement? Whose usage has dropped off?</p>

      <h2 id="tracking-user-ids"><a href="#tracking-user-ids">Tracking User IDs</a></h2>

      <p>Google Analytics accepts custom, site-specific data. It's really simple, just add one line to the snippet Google Analytics provides. The new Google Analytics snippet uses <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/custom-dims-mets">custom dimensions</a>, which you need to <a href="https://support.google.com/analytics/answer/2709829?hl=en">set up explicitly</a>. The older snippet uses <a href="https://developers.google.com/analytics/devguides/collection/gajs/gaTrackingCustomVariables">custom variables</a>, which doesn't require any set up.</p>

      <div class="highlight">
        <pre>
<span class="c1">// For New Snippets</span>
<span class="nx">ga</span><span class="p">(</span><span class="s1">'set'</span><span class="p">,</span> <span class="s1">'dimension1'</span><span class="p">,</span> <span class="o">&lt;%=</span> <span class="nx">current_user</span><span class="p">.</span><span class="nx">id</span> <span class="o">%&gt;</span><span class="p">);</span>

<span class="c1">// For Older Snippets</span>
<span class="nx">_gaq</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s1">'_setCustomVar'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'User'</span><span class="p">,</span> <span class="o">&lt;%=</span> <span class="nx">current_user</span><span class="p">.</span><span class="nx">id</span> <span class="o">%&gt;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre>
      </div>

      <h2 id="querying-google-analytics"><a href="#querying-google-analytics">Querying Google Analytics</a></h2>

      <p>Now that you're associating a specific user with each pageview, you can use the Google Analytics API to group pageviews by user. I use <a href="https://rubygems.org/gems/garb">garb</a>.</p>

      <div class="highlight">
        <pre>
<span class="c1"># For Newer Snippets</span>
<span class="k">class</span> <span class="nc">UserActivity</span>
  <span class="kp">extend</span> <span class="ss">Garb</span><span class="p">:</span><span class="ss">:Model</span>
  <span class="kp">extend</span> <span class="ss">Garb</span><span class="p">:</span><span class="ss">:Queryable</span>

  <span class="n">metrics</span> <span class="ss">:pageviews</span><span class="p">,</span> <span class="ss">:uniquePageviews</span>
  <span class="n">dimensions</span> <span class="ss">:dimension1</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
    <span class="vi">@pageviews</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pageviews</span><span class="o">.</span><span class="n">to_i</span>

    <span class="vi">@user_id</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">dimension1</span><span class="o">.</span><span class="n">to_i</span>
    <span class="vi">@user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="k">if</span> <span class="vi">@user_id</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">user</span>
    <span class="vi">@user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="vi">@user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="k">if</span> <span class="vi">@user_id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">email</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="k">if</span> <span class="n">user</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
      </div>

      <div class="highlight">
        <pre>
<span class="c1"># For Older Snippets</span>
<span class="k">class</span> <span class="nc">UserActivity</span>
  <span class="kp">extend</span> <span class="ss">Garb</span><span class="p">:</span><span class="ss">:Model</span>
  <span class="kp">extend</span> <span class="ss">Garb</span><span class="p">:</span><span class="ss">:Queryable</span>

  <span class="n">metrics</span> <span class="ss">:pageviews</span><span class="p">,</span> <span class="ss">:uniquePageviews</span>
  <span class="n">dimensions</span> <span class="ss">:customVarName1</span><span class="p">,</span> <span class="ss">:customVarValue1</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
    <span class="vi">@pageviews</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pageviews</span><span class="o">.</span><span class="n">to_i</span>

    <span class="vi">@user_id</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">custom_var_value1</span><span class="o">.</span><span class="n">to_i</span> <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">custom_var_name1</span> <span class="o">==</span> <span class="s1">'User'</span>
    <span class="vi">@user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="k">if</span> <span class="vi">@user_id</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">user</span>
    <span class="vi">@user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="vi">@user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="k">if</span> <span class="vi">@user_id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">email</span>
    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="k">if</span> <span class="n">user</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
      </div>

      <div class="highlight">
        <pre>
<span class="k">module</span> <span class="nn">Garb::Queryable</span>

  <span class="c1"># Instead of returning a Struct, return instances of the given class</span>
  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">results</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">arr</span><span class="p">,</span> <span class="n">result</span><span class="o">|</span>
      <span class="n">arr</span> <span class="o">&lt;&lt;</span> <span class="kp">new</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
      </div>

      <h2 id="generating-an-email"><a href="#generating-an-email">Generating an Email</a></h2>

      <p>Emails are a passive way of tracking information. You don't need to go anywhere: it comes to you and fits nicely into most people's daily routines. Let's run a Rake task that authenticates with GA and delivers an email via ActionMailer.</p>

      <div class="highlight">
        <pre>
<span class="k">class</span> <span class="nc">AnalyticsMailer</span> <span class="o">&lt;</span> <span class="ss">ActionMailer</span><span class="p">:</span><span class="ss">:Base</span>

  <span class="k">def</span> <span class="nf">user_activity_report</span><span class="p">(</span><span class="n">to_email</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
    <span class="c1"># Back one week from midnight last night</span>
    <span class="n">start_at</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span> <span class="o">-</span> <span class="mi">1</span><span class="o">.</span><span class="n">week</span>
    <span class="n">end_at</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span>

    <span class="vi">@activities</span> <span class="o">=</span> <span class="no">UserActivity</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">start_at</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">end_at</span><span class="p">)</span>
    <span class="vi">@activities</span><span class="o">.</span><span class="n">sort!</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">b</span><span class="o">.</span><span class="n">pageviews</span> <span class="o">&lt;=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">pageviews</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">if</span> <span class="vi">@activities</span><span class="o">.</span><span class="n">empty?</span>

    <span class="n">mail_to</span><span class="p">({</span>
      <span class="ss">to</span><span class="p">:</span> <span class="n">to_email</span><span class="p">,</span>
      <span class="ss">subject</span><span class="p">:</span> <span class="s2">"[</span><span class="si">#{</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] User Activity"</span>
    <span class="p">})</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
      </div>

      <div class="highlight">
        <pre>
<span class="c">&lt;!-- views/analytics_mailer/user_activity_report.html.erb --&gt;</span>
<span class="nt">&lt;h2&gt;</span>Active Users<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;th&gt;</span>Email<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>Pageviews<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;th&gt;</span>Unique Pageviews<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@activities</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">activity</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">activity</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">activity</span><span class="o">.</span><span class="n">pageviews</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">activity</span><span class="o">.</span><span class="n">unique_pageviews</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre>
      </div>

      <div class="highlight">
        <pre>
<span class="c1"># lib/tasks/analytics.rake</span>
<span class="n">namespace</span> <span class="ss">:analytics</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:user_activity_report</span> <span class="k">do</span>

    <span class="n">desc</span> <span class="s1">'Delivers the user activity report'</span>
    <span class="n">task</span> <span class="ss">deliver</span><span class="p">:</span> <span class="ss">:environment</span> <span class="k">do</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s1">'dan@topdan.com'</span>
      <span class="n">password</span> <span class="o">=</span> <span class="s1">'use-two-factor-auth-instead'</span>
      <span class="n">site_name</span> <span class="o">=</span> <span class="s1">'www.topdan.com'</span> <span class="c1"># name of your Google Analytics "Property"</span>

      <span class="ss">Garb</span><span class="p">:</span><span class="ss">:Session</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
      <span class="c1"># Garb::Session.api_key = api_key # required for 2-step authentication</span>

      <span class="n">profiles</span> <span class="o">=</span> <span class="ss">Garb</span><span class="p">:</span><span class="ss">:Management</span><span class="o">::</span><span class="no">Profile</span><span class="o">.</span><span class="n">all</span>
      <span class="n">profile</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">detect</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">site_name</span> <span class="p">}</span>

      <span class="no">AnalyticsMailer</span><span class="o">.</span><span class="n">user_activity_report</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
      </div>

      <h2 id="scheduling-the-email"><a href="#scheduling-the-email">Scheduling the Email</a></h2>

      <p>The <a href="http://rubygems.org/gems/whenever">whenever</a> gem provides a slick interface for managing your application's <a href="http://en.wikipedia.org/wiki/Cron">cronjobs</a>, with an easy integration into Capistrano.</p>

      <div class="highlight">
        <pre>
<span class="c1"># config/schedule.rb</span>
<span class="n">every</span> <span class="ss">:monday</span><span class="p">,</span> <span class="ss">at</span><span class="p">:</span> <span class="s2">"8:00am"</span> <span class="k">do</span>
  <span class="n">rake</span> <span class="s2">"analytics:user_activity_report:deliver"</span>
<span class="k">end</span>
</pre>
      </div>

      <div class="highlight">
        <pre>
<span class="c1"># config/deploy/production.rb</span>
<span class="nb">require</span> <span class="s2">"whenever/capistrano"</span>
</pre>
      </div>

      <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>

      <p>Now you'll get an email every Monday morning telling you who your most active users were last week. The email takes just a couple seconds to browse over and can really improve and target your customer service and product development.</p>

      <p>Finding your most active users is only the beginning. Google Analytics can answer a lot more questions:</p>

      <ul>
        <li>How much time did a user spend on each page? What was the average?</li>

        <li>What individual pages did a specific someone use? In what order?</li>

        <li>Who are the major users of a specific page?</li>

        <li>Who had 50% more/less pageviews this week than last week?</li>
      </ul>

      <p><a href="https://developers.google.com/analytics/devguides/reporting/core/dimsmets">Check out all the Dimensions &amp; Metrics</a></p><!-- post:content:end -->
    </div>
  </div>

  <div id="footer">
    <ul class="navigation">
      <li class="prev">
        <a href="/ruby-on-rails/ajax-toggle-buttons.html"><i class="icon-white icon-arrow-left">&nbsp;</i> <span class="more">Easy Ajax Toggle Buttons</span><span class="less">Previous</span></a>
      </li>

      <li>
        <a href="/" class="icon"><i class="icon-white icon-home">&nbsp;</i></a>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/technology/">Technology</a></span><span class="less"><a href="/technology/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>&nbsp;&raquo;&nbsp;<span class="title more"><a href="/ruby-on-rails/">Ruby on Rails</a></span><span class="less"><a href="/ruby-on-rails/"><i class="icon white icon-folder-open">&nbsp;</i></a></span>
      </li>

      <li class="next">
        <a href="/ruby-on-rails/simple-infinite-scrolling.html"><span class="more">Simple Infinite Scrolling with AJAX and Rails</span><span class="less">Next</span> <i class="icon-white icon-arrow-right">&nbsp;</i></a>
      </li>
    </ul>

    <div class="introduction row-fluid">
      <div class="title span6">
        <h1><a href="/" title="Dan Cunning">Dan Cunning</a></h1>

        <ul>
          <li>
            <a href="http://twitter.com/itopdan" title="Twitter"><span class="about-twitter">&nbsp;</span> twitter</a>
          </li>

          <li>
            <a href="https://github.com/topdan" title="github"><span class="about-github">&nbsp;</span> github</a>
          </li>

          <li>
            <a href="mailto:dan@topdan.com" title="Email"><span class="about-email">&nbsp;</span> email</a>
          </li>
        </ul>
      </div>

      <div class="profile span6">
        <img alt="Dan" height="75" src="/assets/dan-72f0d7c32b35bf05df5cfd70af8204ab.jpg" width="75">

        <p>I'm a <a href="/ruby-on-rails/">Ruby on Rails</a> contractor from Atlanta GA, focusing on simplicity and usability through solid design. <a href="/dan-cunning.html">Read more &raquo;</a></p>
      </div>
    </div>

    <div id="copyright">
      <p id="view-source">View <a href="https://www.github.com/topdan/www/blob/master/ruby-on-rails/finding-your-most-active-users-with-google-analytics.html">HTML</a> <a href="https://www.github.com/topdan/www/blob/master/ruby-on-rails/finding-your-most-active-users-with-google-analytics.json">JSON</a></p>

      <p>&copy; 2012-2014 Dan Cunning. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
